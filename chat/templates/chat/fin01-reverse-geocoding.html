{% extends 'chat/basetemplate.html' %}

{% block title %}
    Reverzní geocoding
{% endblock %}


{% block body %}


    <!-- UI -->
    <div id="ui-1">
        <form id="targetForm" method="get" action="" onsubmit="event.preventDefault(); search1.goSecond()">
            <div id="ui1_alert" role="alert" class="feedback"></div>
            <label for="InputTargetAddress">Kam jdeš?</label> <input type="text" id="InputTargetAddress"
                                                                     name="TargetAddress"
                                                                     placeholder="např. Myslíkova 22"/>
            <button id="voiceInputButton" onclick="startDictation()">Zadat hlasem</button>
            <input id="submitTargetAddress" type="submit" value="Dál">
        </form>
    </div>

    <!-- UI2 -->
    <div id="ui-2">
        <div id="accuracyLabel">aktuální přesnost:</div>
        <div id="accuracyText" aria-live="polite">sample accuracy text</div>
        <div id="ui2_alert" role="alert" class="feedback"></div>
        <button id="buttonStart" onclick="search1.startNavigation()">Spustit Navigaci</button>
        <button id="buttonBackToFirst" onclick="search1.goSecond()">Zpět</button>
    </div>



    <!-- variables -->
    <script>
        var coords = null;

        var shownAccuracy = 999;
        var prevAccuracy = 999;
    </script>


    <!-- scripts -->
    {% load static %}
    <script src="{% static "chat/voiceInput.js" %}"></script>
    <script src="{% static "js/jquery.js" %}"></script>
    <script src="{% static "chat/apis.js" %}"></script>


    <!-- on load-->
    <script>
        var search1 = null;
        jQuery(document).ready(function () {
            hideVoiceIfNotSupported("voiceInputButton");
            search1 = new Search("InputTargetAddress", "ui1_alert", "ui2_alert", "submitTargetAddress", "buttonBackToFirst", "buttonStart", "accuracy_text", "ui-1", "ui-2")
        });
    </script>

    <!-- HTML5 Speech Recognition API -->
    <script>
        function handleVoiceInput() {
            // todo fill in and read aloud
            startDictation(handleVoiceInput);
        }

    </script>

    <!-- geolocalization -->
    <script>
        function Gps(status_id, callback) {
            this.$status = $("#" + status_id);
            this.callback = callback;
            this.geo_options = {
                enableHighAccuracy: true,
                maximumAge: 30000,
                timeout: 27000
            };


            this.geo_success = function (position) {
                coords = {
                    Latitude: position.coords.latitude,
                    Longitude: position.coords.longitude,
                    Accuracy: position.coords.accuracy,
                };
                this.callback(coords.Accuracy);
            }

            this.geo_error = function () {
                alert("Pardon, napodařilo se načíst pozici.");
            }

            this.startGps = function () {
                if ("geolocation" in navigator) {
                    /* geolocation is available */
                    this.$status.html("Spouštím GPS a určuji tvou přesnou pozici");
                    var watchID = navigator.geolocation.watchPosition(this.geo_success.bind(this), this.geo_error.bind(this), this.geo_options);
                } else {
                    /* geolocation IS NOT available */
                    this.$status.html("Geolokace v prohlížeči nefunguje. Zkus ji zapnout a znovu načíst stránku!")
                }
            }

            this.startGps();
        }


    </script>


    <script>
        function redirectToNavigation(sourceAddress, targetAddress, currentUrl) {
            var sourceEncoded = encodeURIComponent(sourceAddress).replace(/%20/g, '+');
            var targetEncoded = encodeURIComponent(targetAddress).replace(/%20/g, '+');
            var finalUrl = "{% url 'chat:navigateExample'%}?SourceAddress=" + sourceEncoded + "&TargetAddress=" + targetEncoded;
            if (currentUrl !== undefined) {
                var currentUrl = "{{ request.path }}"
                finalUrl += "&PreviousUrl=" + currentUrl
            }
            window.location.replace(finalUrl);
        }
    </script>

    <script>
        function Search(text_id, alert1_id, alert2_id, goSecond_id, goFirst_id, goStart_id, gpsStatus_id, firstPart_id, secondPart_id) {

            // define class properties
            this.$text = $('#' + text_id);   // the jQuery object pointer to the text box
            this.$gosecond = $('#' + goSecond_id); // the jQuery object pointer to the check guess button
            this.$gofirst = $('#' + goFirst_id); // the jQuery object pointer to the check guess button
            this.$alert1 = $('#' + alert1_id); // the jQuery object pointer to the alert area
            this.$alert2 = $('#' + alert2_id); // the jQuery object pointer to the alert area
            this.$firstPart = $('#' + firstPart_id); // the jQuery object pointer to the alert area
            this.$secondPart = $('#' + secondPart_id); // the jQuery object pointer to the alert area
            this.$start = $('#' + goStart_id); // the jQuery object pointer to the alert area
            this.$gpsStatus = $('#' + gpsStatus_id); // the jQuery object pointer to the alert area

            this.firstPart = true;

            this.prevAccuracy = 999;
            this.shownAccuracy = 999;
            this.coords = null;

            this.newSearch = function () {
                // set i am in the first part
                this.firstPart = true;
                this.drawGui();

            }

            this.drawGui = function () {
                if (this.firstPart) {
                    this.$firstPart.show();
                    this.$secondPart.hide();
                } else {
                    this.$firstPart.hide();
                    this.$secondPart.show();
                }
            }

            this.goSecond = function () {
                //validate
                if (this.validate()) {
                    this.firstPart = false;
                    this.drawGui();
                }
            }

            this.goFirst = function () {
                this.firstPart = true;
                this.drawGui();
            }

            this.validate = function () {
                var val = this.$text.val();
                //check if empty
                if (val == '') {
                    this.$text.attr('aria-invalid', 'true');
                    this.$alert1.html('Zapomněl jsi vyplnit kam to bude.');

                    return false;
                } else
                //check if in db
                if (inNaviterierDB(val)) {
                    this.$text.attr('aria-invalid', 'true');
                    this.$alert1.html('\'' + val + '\' není v naší databázi adres');

                    return false;
                }

                this.$text.attr('aria-invalid', 'false');
                return true;
            }

            this.startNavigation = function () {
                var targetAddress = this.$text.val();
                if (this.validateGpsPosition()) {
                    getAddress(coords.Latitude, coords.Longitude, function (sourceAddress) {
                        redirectToNavigation(sourceAddress, targetAddress, "{{ request.url }}");
                    });
                }
            }

            this.validateGpsPosition = function () {
                if (this.coords == null) {
                    this.$alert1.html('\'' + val + '\' není v naší databázi adres');
                    return false;
                }
            }

            this.showGpsStatus = function (newValue) {
                this.prevAccuracy = this.shownAccuracy;
                this.shownAccuracy = Math.round(newValue);
                // when accuracy changes for at least 10m
                if (Math.abs(this.prevAccuracy - this.shownAccuracy) >= 5) {
                    this.$gpsStatus.html("+-" + this.shownAccuracy + "m. ");
                }

            }

            // initialize the new search
            this.newSearch();
            this.gps = new Gps(gpsStatus_id, this.showGpsStatus.bind(this))
        }

    </script>
{% endblock %}